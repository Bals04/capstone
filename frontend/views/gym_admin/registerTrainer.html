<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flexperience</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="stylesheet" href="../../dist/tailwind.css">
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Aldrich&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap');

    input {
        opacity: 1;
    }
</style>

<body class="bg-[#1E1E1E] ml-[14%] mr-[14%] mt-7 text-white font-customFont">
    <div class="">
        <div class="mb-7">
            <span class="font-bold text-2xl">Trainer Registration Form</span><br>
            <span class="text-s font-extralight text-gray-400">Some of the information will be displayed publicly so be
                careful what
                you share.</span>
        </div>
        <div class="flex justify-between gap-2">
            <div>
                <label for="Gym_name" class="font-semibold">First name</label> <br>
                <input type="text" id="first_name" class="w-80 h-10 rounded-lg shadow-51 shadow-inner text-black pl-5"
                    placeholder="First name"> <br>
                <br>
                <label for="Owner_name" class="font-semibold">Last name</label> <br>
                <input type="text" id="last_name" class="w-80 h-10 rounded-lg shadow-51 shadow-inner text-black pl-5"
                    placeholder="Last name"> <br>
                <br>
                <label for="Username" class="font-semibold">Username</label> <br>
                <input type="text" id="username" class="w-80 h-10 rounded-lg shadow-51 shadow-inner text-black pl-5"
                    placeholder="Username"> <br>
                <br>
                <label for="Password" class="font-semibold">Password</label> <br>
                <input type="password" id="password" class="w-80 h-10 rounded-lg shadow-51 shadow-inner text-black pl-5"
                    placeholder="Password"> <br>
                <br>
                <label for="Bio" class="font-semibold">Bio</label> <br>
                <input type="text" id="bio" class="w-80 h-10 rounded-lg shadow-51 shadow-inner text-black pl-5"
                    placeholder="Bio"> <br>
                <br>
                <label for="Experience" class="font-semibold">Years of Experience</label> <br>
                <input type="number" id="experience" class="w-80 h-10 rounded-lg shadow-51 shadow-inner text-black pl-5"
                    placeholder="Years of experience"> <br>
                <br>
            </div>
            <div>
                <label for="gym_select" class="font-semibold">Assign to Gym</label> <br>
                <select id="gym_select" name="gym_select"
                    class="w-80 h-10 rounded-lg shadow-51 shadow-inner text-black pl-5">
                    <!-- Dynamic options will be inserted here -->
                </select> <br>
                <br>

                <label for="rate" class="font-semibold">Rates/Month (in pesos)</label> <br>
                <input type="text" id="rate" name="rate"
                    class="w-80 h-10 rounded-lg shadow-51 shadow-inner text-black pl-5" placeholder="Rates per month">
                <br><br>
                <span class="font-semibold">Proof of Trainer Certification</span><br>
                <span class="font-thin text-xs text-justify opacity-50 w-auto">Upload a copy of your trainer
                    certificate. This is required to verify the legality of your registration.</span>
                <label for="file-input"
                    class="cursor-pointer mb-10 flex items-center gap-x-2 border border-52 shadow-black shadow-md w-36 p-2 rounded-md hover:bg-white hover:text-black duration-300 mt-3">
                    <input type="file" id="file-input" ref="fileInputs" class="hidden" />
                    <span class="font-medium text-white-700 text-[13px]">Upload image</span>
                    <span class="material-symbols-outlined">upload</span>
                </label>
                <label for="profile_image" class="font-semibold">Profile image</label> <br>
                <span class="font-thin text-xs text-justify opacity-50 w-auto">Upload an image for your display
                    profile/avatar.</span>
                <label for="profile_image"
                    class="cursor-pointer flex items-center gap-x-2 border border-52 shadow-black shadow-md w-36 p-2 rounded-md hover:bg-white hover:text-black duration-300 mt-3">
                    <input type="file" id="profile_image" class="hidden" />
                    <span class="font-medium text-white-700 text-[13px]">Upload image</span>
                    <span class="material-symbols-outlined">upload</span>
                </label>
                <br>
                <br>
            </div>
        </div>
        <div class="mt-10 w-full border border-white">
        </div>
        <div class="float-right font-extralight mt-2 mb-10 text-base">
            <button class="pr-5 pl-5 p-1 border border-white rounded-lg hover:bg-black">Cancel</button>
            <button id="submit"
                class="bg-50 rounded-lg pr-5 pl-5 p-1 hover:bg-white hover:text-black duration-200">Submit</button>
        </div>
        <span class="font-thin text-xs text-justify opacity-50">For more information about this website,
            please refer to the [www.Flexperience/About.com]</span>
    </div>
    <div id="error-toast"
        class="fixed top-5 right-5 bg-white border-l-4 border-orange-500 text-gray-800 max-w-md w-full p-4 rounded-lg shadow-lg hidden transition-all duration-300 ease-in-out transform translate-x-full">
        <div class="flex items-center">
            <div class="flex items-center justify-center w-8 h-8 bg-orange-500 rounded-full">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </div>
            <div class="ml-3">
                <h2 class="text-lg font-semibold text-orange-600">Form Error</h2>
                <p id="error-message-toast" class="text-sm text-gray-600">Your error message here</p>
            </div>
            <button id="close-toast-btn" class="ml-auto text-gray-500 hover:text-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>
    </div>
    <!-- Success Toast -->
    <div id="success-toast"
        class="fixed top-5 right-5 bg-white border-l-4 border-green-500 text-gray-800 max-w-md w-full p-4 rounded-lg shadow-lg hidden transition-all duration-300 ease-in-out transform translate-x-full">
        <div class="flex items-center">
            <div class="flex items-center justify-center w-8 h-8 bg-green-500 rounded-full">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 12l5 5L20 7"></path>
                </svg>
            </div>
            <div class="ml-3">
                <h2 class="text-lg font-semibold text-green-600">Success</h2>
                <p id="success-message-toast" class="text-sm text-gray-600">Your success message here</p>
            </div>
            <button id="close-success-toast-btn" class="ml-auto text-gray-500 hover:text-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>
    </div>

</body>

</html>

<script>
    // Call this function when the page loads
    window.onload = async function () {
        try {
            const gymAdminId = getCookie('gymAdminId');
            const response = await axios.get('http://localhost:3000/gymsById', {
                params: {
                    admin_id: gymAdminId
                }
            });
            const gyms = response.data;
            const gymSelect = document.getElementById('gym_select');

            // Loop through the gyms and add them as options to the select element
            gyms.forEach(gym => {
                if (gym.status === "Verified") { // Only add gyms with status 'Verified'
                    const option = document.createElement('option');
                    option.value = gym.gym_id;
                    option.text = gym.gym_name;
                    gymSelect.appendChild(option);
                }
            });
        } catch (error) {
            console.error('Error fetching gyms:', error);
        }
    };

    // Function to store username and password and call AddToAccounts
    document.getElementById('submit').addEventListener('click', async function (event) {
        event.preventDefault();

        const Username = document.getElementById('username').value;
        const Password = document.getElementById('password').value;
        const FirstName = document.getElementById('first_name').value;
        const LastName = document.getElementById('last_name').value;
        const Bio = document.getElementById('bio').value;
        const Experience = document.getElementById('experience').value;
        const GymId = document.getElementById('gym_select').value;
        const Rates = document.getElementById('rate').value;

        try {
            const accountAdded = await AddToAccounts(Username, Password);

            if (accountAdded) {
                await RegisterTrainer(GymId, FirstName, LastName, Bio, Experience, Rates);
            }
        } catch (error) {

        }
    });

    function showToast(type, message) {
        const toast = type === 'success' ? document.getElementById('success-toast') : document.getElementById('error-toast');
        const messageElement = type === 'success' ? document.getElementById('success-message-toast') : document.getElementById('error-message-toast');

        // Set the message
        messageElement.textContent = message;

        // Show and slide in the toast
        toast.classList.remove('hidden', 'translate-x-full'); // Remove hidden and off-screen translation
        toast.classList.add('translate-x-0'); // Move the toast in view

        // Auto-hide the toast after 3 seconds
        setTimeout(() => {
            toast.classList.add('translate-x-full');  // Slide toast out to the right
            setTimeout(() => toast.classList.add('hidden'), 300);  // Hide completely after the transition
        }, 3000);
    }

    // Close button functionality
    document.getElementById('close-toast-btn').addEventListener('click', () => {
        const toast = document.getElementById('error-toast');
        toast.classList.add('translate-x-full');  // Slide out
        setTimeout(() => toast.classList.add('hidden'), 300);  // Hide completely after transition
    });

    document.getElementById('close-success-toast-btn').addEventListener('click', () => {
        const toast = document.getElementById('success-toast');
        toast.classList.add('translate-x-full');  // Slide out
        setTimeout(() => toast.classList.add('hidden'), 300);  // Hide completely after transition
    });

    async function AddToAccounts(Username, Password) {
        try {
            const formData = {
                username: Username,
                password: Password,
                usertype: "Trainer"
            };
            const response = await axios.post('http://localhost:3000/auth/Register', formData);
            console.log('Registration successful:', response.data);
            return true;  // Indicate success
        } catch (error) {
            if (error.response && error.response.data.message) {
                const errorMessage = error.response.data.message;  // Access the error message directly
                console.log(errorMessage);
                showToast('error', errorMessage);  // Display the error message in a modal
            } else {
                console.error('Error submitting Gym Trainer Registration:', error.message);
            }
            console.error('Error submitting registration:', error);
            return false;  // Indicate failure
        }
    }


    async function RegisterTrainer(gymid, firstname, lastname, bio, experience, rates) {
        try {
            const formData = {
                gymid: gymid,
                firstname: firstname,
                lastname: lastname,
                bio: bio,
                experience: experience,
                rates: rates,
                trainerType: "gym trainer"
            };
            let trainer_id;
            const response = await axios.post('http://localhost:3000/createGymTrainer', formData);
            console.log('Trainer registration successful:', response.data.trainerId);
            trainer_id = response.data.trainerId
            uploadTrainerProfile(trainer_id)
            showToast('success', 'Trainer registration successful');
            setTimeout(() => {
                window.location.href = "gymAdminDashboard.html";
            }, 3000);
        } catch (error) {
            if (error.response && error.response.data.message) {
                const errorMessage = error.response.data.message;  // Access the error message directly
                console.log(errorMessage);
                showToast('error', errorMessage);  // Display the error message in a modal
            } else {
                console.error('Error submitting Gym Trainer Registration:', error.message);
            }
        }
    }

    async function uploadTrainerProfile(trainer_id) {
        try {
            const profileImageFile = document.getElementById("profile_image").files[0];

            if (!profileImageFile) {
                alert("::Please select a file to upload.");
                return;
            }

            const formData = new FormData();
            formData.append('file', profileImageFile);  // 'file' should match the key in multer

            // Upload the file using axios (first request)
            axios.post('http://localhost:3000/uploadSingle', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            })
                .then((response) => {
                    const fileName = response.data.fileName; // Assuming filePath contains the uploaded file name
                    console.log("Uploaded file name: ", fileName);
                    alert(`File uploaded successfully: ${fileName}`);

                    // After successful upload, send trainer_id and fileName to the new endpoint
                    return axios.post('http://localhost:3000/insertTrainerImage', {
                        trainer_id: trainer_id,
                        filename: fileName
                    });
                })
                .then((insertResponse) => {
                    console.log("Trainer image inserted successfully:", insertResponse.data);
                    alert('Trainer image linked successfully.');
                })
                .catch((error) => {
                    console.error("Error during upload or insertion: ", error);
                    alert('Error during upload or image insertion.');
                });

        } catch (error) {
            console.error("Unexpected error: ", error);
            alert('Error uploading file.');
        }
    }


    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }
</script>